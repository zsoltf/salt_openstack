heat_template_version: rocky

description: Kubernetes Heat Template

parameters:

  ssh_key_name:
    type: string
    description: name of key pair for ssh
    default: rootkey

  salt_master:
    type: string
    description: name of salt server
    default: catboat.discdrive.bayphoto.com

  flavor:
    type: string
    description: name of flavor for server
    default: m1.medium

  image:
    type: string
    description: name of image for server
    default: bionic

  public_network:
    type: string
    description: name of the public network
    default: boneyard

  kube_vip:
    type: string
    description: vip for kube lb
    default: "10.250.18.9"

  kube_internal_vip:
    type: string
    description: vip for kube lb in private network
    default: "10.9.9.9"

  dns_server:
    type: string
    default: "10.5.48.8"


resources:

  internal-net:
    type: OS::Neutron::Net

  kube-subnet:
    type: OS::Neutron::Subnet
    properties:
      network_id: { get_resource: internal-net }
      cidr: "10.9.9.0/24"
      dns_nameservers:
        - { get_param: dns_server }
        - "10.9.9.2"
      ip_version: 4

  kube-router:
    type: OS::Neutron::Router
    properties:
      external_gateway_info: { network: { get_param: public_network } }

  kube-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: { get_resource: kube-router }
      subnet: { get_resource: kube-subnet }

  kube-lb-vrrp-secgroup:
    type: OS::Neutron::SecurityGroup
    properties:
      rules:
        - protocol: tcp
          remote_ip_prefix: 0.0.0.0/0
          port_range_min: 112
          port_range_max: 112

  kube-lb-https-secgroup:
    type: OS::Neutron::SecurityGroup
    properties:
      rules:
        - protocol: tcp
          remote_ip_prefix: 0.0.0.0/0
          port_range_min: 443
          port_range_max: 443

  kube-lb-vip-float:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: { get_param: public_network }
      floating_ip_address: { get_param: kube_vip }
      value_specs:
        description: 'kube float'
        dns_domain: 'openstack.bayphoto.com.'
        dns_name: 'kubernetes'

  kube-lb-vip-port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: internal-net }
      fixed_ips:
        - ip_address: { get_param: kube_internal_vip }

  kube-lb-vip-association:
    type: OS::Neutron::FloatingIPAssociation
    depends_on:
      - kube-lb-vip-float
      - kube-subnet
      - kube-router
      - kube-router-interface
    properties:
      floatingip_id: { get_resource: kube-lb-vip-float }
      port_id: { get_resource: kube-lb-vip-port }

  kube-lb-1-port:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs:
        - ip_address: { get_attr: [ kube-lb-vip-port, fixed_ips, 0, ip_address] }
      network: { get_resource: internal-net }
      security_groups:
        - default
        - { get_resource: kube-lb-https-secgroup }
        - { get_resource: kube-lb-vrrp-secgroup }

  kube-lb-2-port:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs:
        - ip_address: { get_attr: [ kube-lb-vip-port, fixed_ips, 0, ip_address] }
      network: { get_resource: internal-net }
      security_groups:
        - default
        - { get_resource: kube-lb-https-secgroup }
        - { get_resource: kube-lb-vrrp-secgroup }

  kube-lb-servergroup:
    type: OS::Nova::ServerGroup
    properties:
      name: kube-lb
      policies: [anti-affinity]

  kube-lb-1:
    type: OS::Nova::Server
    properties:
      scheduler_hints: { group: { get_resource: kube-lb-servergroup } }
      flavor: { get_param: flavor }
      image: { get_param: image }
      name: kube-lb-0
      key_name: { get_param: ssh_key_name }
      networks:
        - port: { get_resource: kube-lb-1-port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            bootcmd:
              - 'ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf'
              - 'systemctl mask swap.target'
              - 'swapoff -a'
            apt:
              primary:
                - arches: [default]
                  uri: http://catboat.discdrive.bayphoto.com/ubuntu/
              sources:
                salt:
                  source: "deb http://catboat.discdrive.bayphoto.com/salt/py3/ubuntu/18.04/amd64/2019.2 bionic main"
                  key: |
                    -----BEGIN PGP PUBLIC KEY BLOCK-----
                    Version: GnuPG v2

                    mQENBFOpvpgBCADkP656H41i8fpplEEB8IeLhugyC2rTEwwSclb8tQNYtUiGdna9
                    m38kb0OS2DDrEdtdQb2hWCnswxaAkUunb2qq18vd3dBvlnI+C4/xu5ksZZkRj+fW
                    tArNR18V+2jkwcG26m8AxIrT+m4M6/bgnSfHTBtT5adNfVcTHqiT1JtCbQcXmwVw
                    WbqS6v/LhcsBE//SHne4uBCK/GHxZHhQ5jz5h+3vWeV4gvxS3Xu6v1IlIpLDwUts
                    kT1DumfynYnnZmWTGc6SYyIFXTPJLtnoWDb9OBdWgZxXfHEcBsKGha+bXO+m2tHA
                    gNneN9i5f8oNxo5njrL8jkCckOpNpng18BKXABEBAAG0MlNhbHRTdGFjayBQYWNr
                    YWdpbmcgVGVhbSA8cGFja2FnaW5nQHNhbHRzdGFjay5jb20+iQE4BBMBAgAiBQJT
                    qb6YAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRAOCKFJ3le/vhkqB/0Q
                    WzELZf4d87WApzolLG+zpsJKtt/ueXL1W1KA7JILhXB1uyvVORt8uA9FjmE083o1
                    yE66wCya7V8hjNn2lkLXboOUd1UTErlRg1GYbIt++VPscTxHxwpjDGxDB1/fiX2o
                    nK5SEpuj4IeIPJVE/uLNAwZyfX8DArLVJ5h8lknwiHlQLGlnOu9ulEAejwAKt9CU
                    4oYTszYM4xrbtjB/fR+mPnYh2fBoQO4d/NQiejIEyd9IEEMd/03AJQBuMux62tjA
                    /NwvQ9eqNgLw9NisFNHRWtP4jhAOsshv1WW+zPzu3ozoO+lLHixUIz7fqRk38q8Q
                    9oNR31KvrkSNrFbA3D89uQENBFOpvpgBCADJ79iH10AfAfpTBEQwa6vzUI3Eltqb
                    9aZ0xbZV8V/8pnuU7rqM7Z+nJgldibFk4gFG2bHCG1C5aEH/FmcOMvTKDhJSFQUx
                    uhgxttMArXm2c22OSy1hpsnVG68G32Nag/QFEJ++3hNnbyGZpHnPiYgej3FrerQJ
                    zv456wIsxRDMvJ1NZQB3twoCqwapC6FJE2hukSdWB5yCYpWlZJXBKzlYz/gwD/Fr
                    GL578WrLhKw3UvnJmlpqQaDKwmV2s7MsoZogC6wkHE92kGPG2GmoRD3ALjmCvN1E
                    PsIsQGnwpcXsRpYVCoW7e2nW4wUf7IkFZ94yOCmUq6WreWI4NggRcFC5ABEBAAGJ
                    AR8EGAECAAkFAlOpvpgCGwwACgkQDgihSd5Xv74/NggA08kEdBkiWWwJZUZEy7cK
                    WWcgjnRuOHd4rPeT+vQbOWGu6x4bxuVf9aTiYkf7ZjVF2lPn97EXOEGFWPZeZbH4
                    vdRFH9jMtP+rrLt6+3c9j0M8SIJYwBL1+CNpEC/BuHj/Ra/cmnG5ZNhYebm76h5f
                    T9iPW9fFww36FzFka4VPlvA4oB7ebBtquFg3sdQNU/MmTVV4jPFWXxh4oRDDR+8N
                    1bcPnbB11b5ary99F/mqr7RgQ+YFF0uKRE3SKa7a+6cIuHEZ7Za+zhPaQlzAOZlx
                    fuBmScum8uQTrEF5+Um5zkwC7EXTdH1co/+/V/fpOtxIg4XO4kcugZefVm5ERfVS
                    MA==
                    =dtMN
                    -----END PGP PUBLIC KEY BLOCK-----
            salt_minion:
              conf:
                master: $salt_master
              grains:
                app: kubernetes
                datacenter: openstack
                kube:
                  role: $kube_role
            mounts:
              - [ swap ]
            swap:
              size: 0
            runcmd:
              - salt-call grains.item kube
              - salt-call test.ping
          params:
            "$salt_master": { get_param: salt_master }
            "$kube_role": lb

  kube-lb-2:
    type: OS::Nova::Server
    properties:
      scheduler_hints: { group: { get_resource: kube-lb-servergroup } }
      flavor: { get_param: flavor }
      image: { get_param: image }
      name: kube-lb-1
      key_name: { get_param: ssh_key_name }
      networks:
        - port: { get_resource: kube-lb-2-port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            bootcmd:
              - 'ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf'
              - 'systemctl mask swap.target'
              - 'swapoff -a'
            apt:
              primary:
                - arches: [default]
                  uri: http://catboat.discdrive.bayphoto.com/ubuntu/
              sources:
                salt:
                  source: "deb http://catboat.discdrive.bayphoto.com/salt/py3/ubuntu/18.04/amd64/2019.2 bionic main"
                  key: |
                    -----BEGIN PGP PUBLIC KEY BLOCK-----
                    Version: GnuPG v2

                    mQENBFOpvpgBCADkP656H41i8fpplEEB8IeLhugyC2rTEwwSclb8tQNYtUiGdna9
                    m38kb0OS2DDrEdtdQb2hWCnswxaAkUunb2qq18vd3dBvlnI+C4/xu5ksZZkRj+fW
                    tArNR18V+2jkwcG26m8AxIrT+m4M6/bgnSfHTBtT5adNfVcTHqiT1JtCbQcXmwVw
                    WbqS6v/LhcsBE//SHne4uBCK/GHxZHhQ5jz5h+3vWeV4gvxS3Xu6v1IlIpLDwUts
                    kT1DumfynYnnZmWTGc6SYyIFXTPJLtnoWDb9OBdWgZxXfHEcBsKGha+bXO+m2tHA
                    gNneN9i5f8oNxo5njrL8jkCckOpNpng18BKXABEBAAG0MlNhbHRTdGFjayBQYWNr
                    YWdpbmcgVGVhbSA8cGFja2FnaW5nQHNhbHRzdGFjay5jb20+iQE4BBMBAgAiBQJT
                    qb6YAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRAOCKFJ3le/vhkqB/0Q
                    WzELZf4d87WApzolLG+zpsJKtt/ueXL1W1KA7JILhXB1uyvVORt8uA9FjmE083o1
                    yE66wCya7V8hjNn2lkLXboOUd1UTErlRg1GYbIt++VPscTxHxwpjDGxDB1/fiX2o
                    nK5SEpuj4IeIPJVE/uLNAwZyfX8DArLVJ5h8lknwiHlQLGlnOu9ulEAejwAKt9CU
                    4oYTszYM4xrbtjB/fR+mPnYh2fBoQO4d/NQiejIEyd9IEEMd/03AJQBuMux62tjA
                    /NwvQ9eqNgLw9NisFNHRWtP4jhAOsshv1WW+zPzu3ozoO+lLHixUIz7fqRk38q8Q
                    9oNR31KvrkSNrFbA3D89uQENBFOpvpgBCADJ79iH10AfAfpTBEQwa6vzUI3Eltqb
                    9aZ0xbZV8V/8pnuU7rqM7Z+nJgldibFk4gFG2bHCG1C5aEH/FmcOMvTKDhJSFQUx
                    uhgxttMArXm2c22OSy1hpsnVG68G32Nag/QFEJ++3hNnbyGZpHnPiYgej3FrerQJ
                    zv456wIsxRDMvJ1NZQB3twoCqwapC6FJE2hukSdWB5yCYpWlZJXBKzlYz/gwD/Fr
                    GL578WrLhKw3UvnJmlpqQaDKwmV2s7MsoZogC6wkHE92kGPG2GmoRD3ALjmCvN1E
                    PsIsQGnwpcXsRpYVCoW7e2nW4wUf7IkFZ94yOCmUq6WreWI4NggRcFC5ABEBAAGJ
                    AR8EGAECAAkFAlOpvpgCGwwACgkQDgihSd5Xv74/NggA08kEdBkiWWwJZUZEy7cK
                    WWcgjnRuOHd4rPeT+vQbOWGu6x4bxuVf9aTiYkf7ZjVF2lPn97EXOEGFWPZeZbH4
                    vdRFH9jMtP+rrLt6+3c9j0M8SIJYwBL1+CNpEC/BuHj/Ra/cmnG5ZNhYebm76h5f
                    T9iPW9fFww36FzFka4VPlvA4oB7ebBtquFg3sdQNU/MmTVV4jPFWXxh4oRDDR+8N
                    1bcPnbB11b5ary99F/mqr7RgQ+YFF0uKRE3SKa7a+6cIuHEZ7Za+zhPaQlzAOZlx
                    fuBmScum8uQTrEF5+Um5zkwC7EXTdH1co/+/V/fpOtxIg4XO4kcugZefVm5ERfVS
                    MA==
                    =dtMN
                    -----END PGP PUBLIC KEY BLOCK-----
            salt_minion:
              conf:
                master: $salt_master
              grains:
                app: kubernetes
                datacenter: openstack
                kube:
                  role: $kube_role
            mounts:
              - [ swap ]
            swap:
              size: 0
            runcmd:
              - salt-call grains.item kube
              - salt-call test.ping
          params:
            "$salt_master": { get_param: salt_master }
            "$kube_role": lb


  kube-etcd-servergroup:
    type: OS::Nova::ServerGroup
    properties:
      name: kube-etcd
      policies: [ anti-affinity ]

  kube-etcd-group:
    type: OS::Heat::ResourceGroup
    properties:
      count: 3
      resource_def:
        type: OS::Nova::Server
        properties:
          scheduler_hints: { group: { get_resource: kube-etcd-servergroup } }
          flavor: { get_param: flavor }
          image: { get_param: image }
          name: kube-etcd-%index%
          key_name: { get_param: ssh_key_name }
          networks:
            - network: { get_resource: internal-net }
          user_data_format: RAW
          user_data:
            str_replace:
              template: |
                #cloud-config
                bootcmd:
                  - 'ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf'
                  - 'systemctl mask swap.target'
                  - 'swapoff -a'
                apt:
                  primary:
                    - arches: [default]
                      uri: http://catboat.discdrive.bayphoto.com/ubuntu/
                  sources:
                    salt:
                      source: "deb http://catboat.discdrive.bayphoto.com/salt/py3/ubuntu/18.04/amd64/2019.2 bionic main"
                      key: |
                        -----BEGIN PGP PUBLIC KEY BLOCK-----
                        Version: GnuPG v2

                        mQENBFOpvpgBCADkP656H41i8fpplEEB8IeLhugyC2rTEwwSclb8tQNYtUiGdna9
                        m38kb0OS2DDrEdtdQb2hWCnswxaAkUunb2qq18vd3dBvlnI+C4/xu5ksZZkRj+fW
                        tArNR18V+2jkwcG26m8AxIrT+m4M6/bgnSfHTBtT5adNfVcTHqiT1JtCbQcXmwVw
                        WbqS6v/LhcsBE//SHne4uBCK/GHxZHhQ5jz5h+3vWeV4gvxS3Xu6v1IlIpLDwUts
                        kT1DumfynYnnZmWTGc6SYyIFXTPJLtnoWDb9OBdWgZxXfHEcBsKGha+bXO+m2tHA
                        gNneN9i5f8oNxo5njrL8jkCckOpNpng18BKXABEBAAG0MlNhbHRTdGFjayBQYWNr
                        YWdpbmcgVGVhbSA8cGFja2FnaW5nQHNhbHRzdGFjay5jb20+iQE4BBMBAgAiBQJT
                        qb6YAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRAOCKFJ3le/vhkqB/0Q
                        WzELZf4d87WApzolLG+zpsJKtt/ueXL1W1KA7JILhXB1uyvVORt8uA9FjmE083o1
                        yE66wCya7V8hjNn2lkLXboOUd1UTErlRg1GYbIt++VPscTxHxwpjDGxDB1/fiX2o
                        nK5SEpuj4IeIPJVE/uLNAwZyfX8DArLVJ5h8lknwiHlQLGlnOu9ulEAejwAKt9CU
                        4oYTszYM4xrbtjB/fR+mPnYh2fBoQO4d/NQiejIEyd9IEEMd/03AJQBuMux62tjA
                        /NwvQ9eqNgLw9NisFNHRWtP4jhAOsshv1WW+zPzu3ozoO+lLHixUIz7fqRk38q8Q
                        9oNR31KvrkSNrFbA3D89uQENBFOpvpgBCADJ79iH10AfAfpTBEQwa6vzUI3Eltqb
                        9aZ0xbZV8V/8pnuU7rqM7Z+nJgldibFk4gFG2bHCG1C5aEH/FmcOMvTKDhJSFQUx
                        uhgxttMArXm2c22OSy1hpsnVG68G32Nag/QFEJ++3hNnbyGZpHnPiYgej3FrerQJ
                        zv456wIsxRDMvJ1NZQB3twoCqwapC6FJE2hukSdWB5yCYpWlZJXBKzlYz/gwD/Fr
                        GL578WrLhKw3UvnJmlpqQaDKwmV2s7MsoZogC6wkHE92kGPG2GmoRD3ALjmCvN1E
                        PsIsQGnwpcXsRpYVCoW7e2nW4wUf7IkFZ94yOCmUq6WreWI4NggRcFC5ABEBAAGJ
                        AR8EGAECAAkFAlOpvpgCGwwACgkQDgihSd5Xv74/NggA08kEdBkiWWwJZUZEy7cK
                        WWcgjnRuOHd4rPeT+vQbOWGu6x4bxuVf9aTiYkf7ZjVF2lPn97EXOEGFWPZeZbH4
                        vdRFH9jMtP+rrLt6+3c9j0M8SIJYwBL1+CNpEC/BuHj/Ra/cmnG5ZNhYebm76h5f
                        T9iPW9fFww36FzFka4VPlvA4oB7ebBtquFg3sdQNU/MmTVV4jPFWXxh4oRDDR+8N
                        1bcPnbB11b5ary99F/mqr7RgQ+YFF0uKRE3SKa7a+6cIuHEZ7Za+zhPaQlzAOZlx
                        fuBmScum8uQTrEF5+Um5zkwC7EXTdH1co/+/V/fpOtxIg4XO4kcugZefVm5ERfVS
                        MA==
                        =dtMN
                        -----END PGP PUBLIC KEY BLOCK-----
                salt_minion:
                  conf:
                    master: $salt_master
                  grains:
                    app: kubernetes
                    datacenter: openstack
                    kube:
                      role: $kube_role
                mounts:
                  - [ swap ]
                swap:
                  size: 0
                runcmd:
                  - salt-call grains.item kube
                  - salt-call test.ping
              params:
                "$salt_master": { get_param: salt_master }
                "$kube_role": etcd


  kube-master-servergroup:
    type: OS::Nova::ServerGroup
    properties:
      name: kube-master
      policies: [anti-affinity]

  kube-master-group:
    type: OS::Heat::ResourceGroup
    properties:
      count: 3
      resource_def:
        type: OS::Nova::Server
        properties:
          scheduler_hints: { group: { get_resource: kube-master-servergroup } }
          flavor: { get_param: flavor }
          image: { get_param: image }
          name: kube-master-%index%
          key_name: { get_param: ssh_key_name }
          networks:
            - network: { get_resource: internal-net }
          user_data_format: RAW
          user_data:
            str_replace:
              template: |
                #cloud-config
                bootcmd:
                  - 'ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf'
                  - 'systemctl mask swap.target'
                  - 'swapoff -a'
                apt:
                  primary:
                    - arches: [default]
                      uri: http://catboat.discdrive.bayphoto.com/ubuntu/
                  sources:
                    salt:
                      source: "deb http://catboat.discdrive.bayphoto.com/salt/py3/ubuntu/18.04/amd64/2019.2 bionic main"
                      key: |
                        -----BEGIN PGP PUBLIC KEY BLOCK-----
                        Version: GnuPG v2

                        mQENBFOpvpgBCADkP656H41i8fpplEEB8IeLhugyC2rTEwwSclb8tQNYtUiGdna9
                        m38kb0OS2DDrEdtdQb2hWCnswxaAkUunb2qq18vd3dBvlnI+C4/xu5ksZZkRj+fW
                        tArNR18V+2jkwcG26m8AxIrT+m4M6/bgnSfHTBtT5adNfVcTHqiT1JtCbQcXmwVw
                        WbqS6v/LhcsBE//SHne4uBCK/GHxZHhQ5jz5h+3vWeV4gvxS3Xu6v1IlIpLDwUts
                        kT1DumfynYnnZmWTGc6SYyIFXTPJLtnoWDb9OBdWgZxXfHEcBsKGha+bXO+m2tHA
                        gNneN9i5f8oNxo5njrL8jkCckOpNpng18BKXABEBAAG0MlNhbHRTdGFjayBQYWNr
                        YWdpbmcgVGVhbSA8cGFja2FnaW5nQHNhbHRzdGFjay5jb20+iQE4BBMBAgAiBQJT
                        qb6YAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRAOCKFJ3le/vhkqB/0Q
                        WzELZf4d87WApzolLG+zpsJKtt/ueXL1W1KA7JILhXB1uyvVORt8uA9FjmE083o1
                        yE66wCya7V8hjNn2lkLXboOUd1UTErlRg1GYbIt++VPscTxHxwpjDGxDB1/fiX2o
                        nK5SEpuj4IeIPJVE/uLNAwZyfX8DArLVJ5h8lknwiHlQLGlnOu9ulEAejwAKt9CU
                        4oYTszYM4xrbtjB/fR+mPnYh2fBoQO4d/NQiejIEyd9IEEMd/03AJQBuMux62tjA
                        /NwvQ9eqNgLw9NisFNHRWtP4jhAOsshv1WW+zPzu3ozoO+lLHixUIz7fqRk38q8Q
                        9oNR31KvrkSNrFbA3D89uQENBFOpvpgBCADJ79iH10AfAfpTBEQwa6vzUI3Eltqb
                        9aZ0xbZV8V/8pnuU7rqM7Z+nJgldibFk4gFG2bHCG1C5aEH/FmcOMvTKDhJSFQUx
                        uhgxttMArXm2c22OSy1hpsnVG68G32Nag/QFEJ++3hNnbyGZpHnPiYgej3FrerQJ
                        zv456wIsxRDMvJ1NZQB3twoCqwapC6FJE2hukSdWB5yCYpWlZJXBKzlYz/gwD/Fr
                        GL578WrLhKw3UvnJmlpqQaDKwmV2s7MsoZogC6wkHE92kGPG2GmoRD3ALjmCvN1E
                        PsIsQGnwpcXsRpYVCoW7e2nW4wUf7IkFZ94yOCmUq6WreWI4NggRcFC5ABEBAAGJ
                        AR8EGAECAAkFAlOpvpgCGwwACgkQDgihSd5Xv74/NggA08kEdBkiWWwJZUZEy7cK
                        WWcgjnRuOHd4rPeT+vQbOWGu6x4bxuVf9aTiYkf7ZjVF2lPn97EXOEGFWPZeZbH4
                        vdRFH9jMtP+rrLt6+3c9j0M8SIJYwBL1+CNpEC/BuHj/Ra/cmnG5ZNhYebm76h5f
                        T9iPW9fFww36FzFka4VPlvA4oB7ebBtquFg3sdQNU/MmTVV4jPFWXxh4oRDDR+8N
                        1bcPnbB11b5ary99F/mqr7RgQ+YFF0uKRE3SKa7a+6cIuHEZ7Za+zhPaQlzAOZlx
                        fuBmScum8uQTrEF5+Um5zkwC7EXTdH1co/+/V/fpOtxIg4XO4kcugZefVm5ERfVS
                        MA==
                        =dtMN
                        -----END PGP PUBLIC KEY BLOCK-----
                salt_minion:
                  conf:
                    master: $salt_master
                  grains:
                    app: kubernetes
                    datacenter: openstack
                    kube:
                      role: $kube_role
                mounts:
                  - [ swap ]
                swap:
                  size: 0
                runcmd:
                  - salt-call grains.item kube
                  - salt-call test.ping
              params:
                "$salt_master": { get_param: salt_master }
                "$kube_role": master


  kube-worker-servergroup:
    type: OS::Nova::ServerGroup
    properties:
      name: kube-worker
      policies: [anti-affinity]

  kube-worker-group:
    type: OS::Heat::ResourceGroup
    properties:
      count: 3
      resource_def:
        type: OS::Nova::Server
        properties:
          scheduler_hints: { group: { get_resource: kube-worker-servergroup } }
          flavor: { get_param: flavor }
          image: { get_param: image }
          name: kube-worker-%index%
          key_name: { get_param: ssh_key_name }
          networks:
            - network: { get_resource: internal-net }
          user_data_format: RAW
          user_data:
            str_replace:
              template: |
                #cloud-config
                bootcmd:
                  - 'ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf'
                  - 'systemctl mask swap.target'
                  - 'swapoff -a'
                apt:
                  primary:
                    - arches: [default]
                      uri: http://catboat.discdrive.bayphoto.com/ubuntu/
                  sources:
                    salt:
                      source: "deb http://catboat.discdrive.bayphoto.com/salt/py3/ubuntu/18.04/amd64/2019.2 bionic main"
                      key: |
                        -----BEGIN PGP PUBLIC KEY BLOCK-----
                        Version: GnuPG v2

                        mQENBFOpvpgBCADkP656H41i8fpplEEB8IeLhugyC2rTEwwSclb8tQNYtUiGdna9
                        m38kb0OS2DDrEdtdQb2hWCnswxaAkUunb2qq18vd3dBvlnI+C4/xu5ksZZkRj+fW
                        tArNR18V+2jkwcG26m8AxIrT+m4M6/bgnSfHTBtT5adNfVcTHqiT1JtCbQcXmwVw
                        WbqS6v/LhcsBE//SHne4uBCK/GHxZHhQ5jz5h+3vWeV4gvxS3Xu6v1IlIpLDwUts
                        kT1DumfynYnnZmWTGc6SYyIFXTPJLtnoWDb9OBdWgZxXfHEcBsKGha+bXO+m2tHA
                        gNneN9i5f8oNxo5njrL8jkCckOpNpng18BKXABEBAAG0MlNhbHRTdGFjayBQYWNr
                        YWdpbmcgVGVhbSA8cGFja2FnaW5nQHNhbHRzdGFjay5jb20+iQE4BBMBAgAiBQJT
                        qb6YAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRAOCKFJ3le/vhkqB/0Q
                        WzELZf4d87WApzolLG+zpsJKtt/ueXL1W1KA7JILhXB1uyvVORt8uA9FjmE083o1
                        yE66wCya7V8hjNn2lkLXboOUd1UTErlRg1GYbIt++VPscTxHxwpjDGxDB1/fiX2o
                        nK5SEpuj4IeIPJVE/uLNAwZyfX8DArLVJ5h8lknwiHlQLGlnOu9ulEAejwAKt9CU
                        4oYTszYM4xrbtjB/fR+mPnYh2fBoQO4d/NQiejIEyd9IEEMd/03AJQBuMux62tjA
                        /NwvQ9eqNgLw9NisFNHRWtP4jhAOsshv1WW+zPzu3ozoO+lLHixUIz7fqRk38q8Q
                        9oNR31KvrkSNrFbA3D89uQENBFOpvpgBCADJ79iH10AfAfpTBEQwa6vzUI3Eltqb
                        9aZ0xbZV8V/8pnuU7rqM7Z+nJgldibFk4gFG2bHCG1C5aEH/FmcOMvTKDhJSFQUx
                        uhgxttMArXm2c22OSy1hpsnVG68G32Nag/QFEJ++3hNnbyGZpHnPiYgej3FrerQJ
                        zv456wIsxRDMvJ1NZQB3twoCqwapC6FJE2hukSdWB5yCYpWlZJXBKzlYz/gwD/Fr
                        GL578WrLhKw3UvnJmlpqQaDKwmV2s7MsoZogC6wkHE92kGPG2GmoRD3ALjmCvN1E
                        PsIsQGnwpcXsRpYVCoW7e2nW4wUf7IkFZ94yOCmUq6WreWI4NggRcFC5ABEBAAGJ
                        AR8EGAECAAkFAlOpvpgCGwwACgkQDgihSd5Xv74/NggA08kEdBkiWWwJZUZEy7cK
                        WWcgjnRuOHd4rPeT+vQbOWGu6x4bxuVf9aTiYkf7ZjVF2lPn97EXOEGFWPZeZbH4
                        vdRFH9jMtP+rrLt6+3c9j0M8SIJYwBL1+CNpEC/BuHj/Ra/cmnG5ZNhYebm76h5f
                        T9iPW9fFww36FzFka4VPlvA4oB7ebBtquFg3sdQNU/MmTVV4jPFWXxh4oRDDR+8N
                        1bcPnbB11b5ary99F/mqr7RgQ+YFF0uKRE3SKa7a+6cIuHEZ7Za+zhPaQlzAOZlx
                        fuBmScum8uQTrEF5+Um5zkwC7EXTdH1co/+/V/fpOtxIg4XO4kcugZefVm5ERfVS
                        MA==
                        =dtMN
                        -----END PGP PUBLIC KEY BLOCK-----
                salt_minion:
                  conf:
                    master: $salt_master
                  grains:
                    app: kubernetes
                    datacenter: openstack
                    kube:
                      role: $kube_role
                mounts:
                  - [ swap ]
                swap:
                  size: 0
                runcmd:
                  - salt-call grains.item kube
                  - salt-call test.ping
              params:
                "$salt_master": { get_param: salt_master }
                "$kube_role": worker

outputs:
  lb:
    description: Public IP of kube lb group
    value: { get_attr: [ kube-lb-1, first_address ] }
  #etcd:
  #  description: Public IP of kube etcd group
  #  value: { get_attr: [ kube-etcd-group, first_address ] }
  #master:
  #  description: Public IP of kube master group
  #  value: { get_attr: [ kube-master-group, first_address ] }
  #worker:
  #  description: Public IP of kube worker group
  #  value: { get_attr: [ kube-worker-group, first_address ] }
